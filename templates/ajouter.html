<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Gestion de Stock</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      background-color: #1c1c2b !important;
    }
    .logo {
      max-height: 50px;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    footer {
      background-color: #f1f1f1;
      border-top: 1px solid #ddd;
      margin-top: 80px;
      padding: 20px;
      font-size: 0.85rem;
      color: #555;
      text-align: center;
    }
    .table-striped tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .pagination {
      justify-content: center;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark px-4">
  <a class="navbar-brand d-flex align-items-center" href="/">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo me-2">
    <span class="text-white fw-bold"></span>
  </a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ms-auto">
      {% set nav_links = [
        ('home', _('Accueil')),
        ('ajouter', _('Ingr√©dients')),
        ('recettes', _('Recettes')),
        ('ventes', _('Ventes')),
        ('transfert', _('Entr√©es (cuisine)')),
        ('pointage_bar', _('Bar')),
        ('entrees_boissons', _('Livraisons Bar'))
      ] %}
      {% for endpoint, label in nav_links %}
      <li class="nav-item">
        <a class="nav-link {{ 'active text-warning fw-bold' if request.path == url_for(endpoint) else '' }}"
           href="{{ url_for(endpoint) }}">{{ label }}{% if endpoint == 'ajouter' and nb_alertes > 0 %} <span class="badge bg-danger rounded-pill">{{ nb_alertes }}</span>{% endif %}</a>
      </li>
      {% endfor %}
      <li class="nav-item ms-3 d-flex align-items-center">
        <span class="text-white-50 me-2 small">{{ current_user.username }}</span>
        <a class="nav-link text-warning" href="{{ url_for('logout') }}">{{ _('D√©connexion') }}</a>
      </li>
      <li class="nav-item ms-2 d-flex align-items-center gap-1">
        <a href="{{ url_for('set_language', lang='fr') }}"
           class="nav-link small py-0 px-1 {% if session.get('lang','fr')=='fr' %}text-white fw-bold{% else %}text-white-50{% endif %}">FR</a>
        <span class="text-white-50 small">|</span>
        <a href="{{ url_for('set_language', lang='en') }}"
           class="nav-link small py-0 px-1 {% if session.get('lang','fr')=='en' %}text-white fw-bold{% else %}text-white-50{% endif %}">EN</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container mt-5">

  <h1 class="text-center mb-4">‚ûï {{ _('Ajouter un ingr√©dient') }}</h1>

  <div class="card shadow mb-5 mx-auto" style="max-width: 600px;">
    <div class="card-body">
      <form method="POST" action="{{ url_for('ajouter') }}">
        <div class="mb-3">
          <label class="form-label">{{ _('Nom') }} :</label>
          <input type="text" name="nom" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('Unit√©') }} :</label>
          <input type="text" name="unite" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('Stock Magasin') }} :</label>
          <input type="number" step="0.01" name="stock_magasin" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('Stock Cuisine') }} :</label>
          <input type="number" step="0.01" name="stock_cuisine" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _("Seuil d'alerte (optionnel)") }} :</label>
          <input type="number" step="0.01" name="seuil_alerte" class="form-control" placeholder="{{ _(\"Laisser vide si pas d'alerte\") }}">
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-success">{{ _('Ajouter') }}</button>
          <a href="{{ url_for('home') }}" class="btn btn-outline-secondary ms-2">{{ _('Annuler') }}</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-header bg-secondary text-white">üìã {{ _('Ingr√©dients existants') }}</div>
    <div class="card-body">

      <input type="text" id="searchInput" class="form-control mb-3" placeholder="üîç {{ _('Rechercher...') }}">

      {% if ingredients %}
      <div class="table-responsive">
        <table id="ingredientsTable" class="table table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>{{ _('Nom') }}</th>
              <th>{{ _('Unit√©') }}</th>
              <th>{{ _('Stock Cuisine') }}</th>
              <th>{{ _('Stock Magasin') }}</th>
              <th>{{ _('Seuil alerte') }}</th>
              <th class="text-center">{{ _('Actions') }}</th>
            </tr>
          </thead>
          <tbody id="ingredientsBody">
            {% for ingr in ingredients %}
            <tr>
              <form method="POST" action="{{ url_for('modifier', id=ingr.id) }}">
                <td><input name="nom" value="{{ ingr.nom }}" class="form-control form-control-sm" readonly></td>
                <td><input name="unite" value="{{ ingr.unite }}" class="form-control form-control-sm" required></td>
                <td><input name="stock_cuisine" type="number" step="0.01" value="{{ ingr.stock_cuisine }}" class="form-control form-control-sm" required></td>
                <td><input name="stock_magasin" type="number" step="0.01" value="{{ ingr.stock_magasin }}" class="form-control form-control-sm" required></td>
                <td><input name="seuil_alerte" type="number" step="0.01" value="{{ ingr.seuil_alerte if ingr.seuil_alerte is not none else '' }}" class="form-control form-control-sm" placeholder="‚Äî"></td>
                <td class="text-end">
                  <button class="btn btn-warning btn-sm" type="submit" title="Modifier">‚úè</button>
                  <a href="{{ url_for('supprimer', id=ingr.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer {{ ingr.nom }} ?')">üóë</a>
                </td>
              </form>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav>
        <ul id="pagination" class="pagination mt-4"></ul>
      </nav>
      {% else %}
      <p class="text-muted">{{ _('Aucun ingr√©dient enregistr√©.') }}</p>
      {% endif %}
    </div>
  </div>

  <div class="text-center mt-4">
    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">{{ _("‚Üê Retour √† l'accueil") }}</a>
  </div>

</div>

<footer>
  ¬© {{ current_time.year }} Lotus Garden Stock Manager by Melvina MIGAN ‚Äî Tous droits r√©serv√©s.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const rowsPerPage = 10;
let currentPage = 1;
const table = document.getElementById("ingredientsTable");
const tbody = document.getElementById("ingredientsBody");
const searchInput = document.getElementById("searchInput");

function updatePagination(filteredRows) {
  const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const li = document.createElement("li");
    li.className = "page-item" + (i === currentPage ? " active" : "");
    li.innerHTML = `<button class="page-link">${i}</button>`;
    li.addEventListener("click", () => {
      currentPage = i;
      showPage(filteredRows);
      updatePagination(filteredRows);
    });
    pagination.appendChild(li);
  }
}

function showPage(rows) {
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  Array.from(rows).forEach((row, i) => {
    row.style.display = (i >= start && i < end) ? "" : "none";
  });
}

function filterAndPaginate() {
  const filter = searchInput.value.toLowerCase();
  const rows = tbody.querySelectorAll("tr");
  const filteredRows = Array.from(rows).filter(row => {
    const nom = row.querySelector('input[name="nom"]').value.toLowerCase();
    const unite = row.querySelector('input[name="unite"]').value.toLowerCase();
    return nom.includes(filter) || unite.includes(filter);
  });

  currentPage = 1;
  showPage(filteredRows);
  updatePagination(filteredRows);
}

searchInput.addEventListener("input", filterAndPaginate);
window.addEventListener("load", filterAndPaginate);
</script>
</body>
</html>
